PUSH 0
LABEL BEGIN
# 読む
INC

LABEL BEGIN2
DUP
PUSH 32
SUB
JEZ SPACE

DUP
PUSH 10
SUB
JEZ OUT

DUP
PUSH 40
SUB
JEZ DIVE

DUP
PUSH 41
SUB
JEZ CANCEL

DUP
PUSH 47
GREATER
NOT
JEZ READNUM

PUSH 2
PUSH 1
ROLL
PUSH 1
ADD
JMP BEGIN

LABEL OUT
# \n なら出力
POP
POP
OUTN
HALT

LABEL DIVE
# ( なら依代を乗せる
PUSH 1
JMP BEGIN

LABEL SPACE
# ' 'なら読み飛ばす
POP
JMP BEGIN

LABEL READNUM
# >=48なら数字を読む
PUSH 0
PUSH 2
PUSH 1
ROLL
LABEL READNUMLOOP
PUSH 48
SUB
PUSH 2
PUSH 1
ROLL
PUSH 10
MUL
ADD
INC
DUP
PUSH 47
GREATER
JEZ AFTERREADNUM
JMP READNUMLOOP

LABEL AFTERREADNUM
# 依代を正しい位置に持ってくる
PUSH 3
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
PUSH 1
ADD
PUSH 3
PUSH 2
ROLL
JMP BEGIN2

LABEL CANCEL
# ) なら簡約
PUSH 2
PUSH 1
ROLL
PUSH 1
ADD
DUP
DUP
PUSH 1
SUB
ROLL
DUP
PUSH 43
SUB
# 43 = +
JEZ ADD
DUP
PUSH 45
SUB
# 45 = -
JEZ SUB
DUP
PUSH 42
SUB
# 42 = *
JEZ MUL
DUP
PUSH 47
SUB
# 47 = /
JEZ DIV

LABEL ADD
# 加算
POP
PUSH 1
SUB
# ( ... ( A B ... C ) N
DUP
PUSH 3
PUSH 1
ROLL
PUSH 1
ADD
PUSH 1
ROLL
DUP
PUSH 2
SUB
PUSH 2
PUSH 1
ROLL
LABEL ADDLOOP
# ( ... ( ) A B .. C m N
PUSH 2
PUSH 1
ROLL
DUP
PUSH 1
SUB
JEZ ADDCOMPRESS
PUSH 2
PUSH 1
ROLL
PUSH 3
PUSH 1
ROLL
DUP
PUSH 4
PUSH 1
ROLL
PUSH 2
ADD
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C A B ..  m-1 N
JMP ADDLOOP

LABEL ADDCOMPRESS
POP
PUSH 0
# ( ... ( ) C .. B A N 0
LABEL ADDCOMPRESSLOOP
PUSH 2
PUSH 1
ROLL
DUP
PUSH 2
SUB
JEZ CANCELEND
# ( ... ( ) C .. B A SUM N
PUSH 1
SUB
PUSH 3
PUSH 1
ROLL
ADD
JMP ADDCOMPRESSLOOP

LABEL SUB
# 減算
POP
PUSH 1
SUB
# ( ... ( A B ... C ) N
DUP
PUSH 3
PUSH 1
ROLL
PUSH 1
ADD
PUSH 1
ROLL
DUP
PUSH 2
SUB
PUSH 2
PUSH 1
ROLL
# 減算は引数1個の時と>=2個の時で処理内容が違う
DUP
PUSH 3
SUB
JEZ SUB1
JMP SUBLOOP

LABEL SUB1
# ( ... ( ) A m 1
POP
POP
PUSH 0
PUSH 2
PUSH 1
ROLL
SUB
PUSH 1
# CANCELENDでPOPするためのダミーの数字
JMP CANCELEND

LABEL SUBLOOP
# ( ... ( ) A B .. C m N
PUSH 2
PUSH 1
ROLL
DUP
PUSH 1
SUB
JEZ SUBCOMPRESS
PUSH 2
PUSH 1
ROLL
PUSH 3
PUSH 1
ROLL
DUP
PUSH 4
PUSH 1
ROLL
PUSH 2
ADD
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C A B ..  m-1 N
JMP SUBLOOP

LABEL SUBCOMPRESS
POP
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C .. B N-1 A
LABEL SUBCOMPRESSLOOP
PUSH 2
PUSH 1
ROLL
DUP
PUSH 2
SUB
JEZ CANCELEND
PUSH 1
SUB
PUSH 3
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
SUB
JMP SUBCOMPRESSLOOP

LABEL MUL
# 乗算
POP
PUSH 1
SUB
# ( ... ( A B ... C ) N
DUP
PUSH 3
PUSH 1
ROLL
PUSH 1
ADD
PUSH 1
ROLL
DUP
PUSH 2
SUB
PUSH 2
PUSH 1
ROLL
LABEL MULLOOP
# ( ... ( ) A B .. C m N
PUSH 2
PUSH 1
ROLL
DUP
PUSH 1
SUB
JEZ MULCOMPRESS
PUSH 2
PUSH 1
ROLL
PUSH 3
PUSH 1
ROLL
DUP
PUSH 4
PUSH 1
ROLL
PUSH 2
ADD
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C A B ..  m-1 N
JMP MULLOOP

LABEL MULCOMPRESS
POP
PUSH 1
# ( ... ( ) C .. B A N 1
LABEL MULCOMPRESSLOOP
PUSH 2
PUSH 1
ROLL
DUP
PUSH 2
SUB
JEZ CANCELEND
# ( ... ( ) C .. B A PRODUCT N
PUSH 1
SUB
PUSH 3
PUSH 1
ROLL
MUL
JMP MULCOMPRESSLOOP
JMP BEGIN

LABEL DIV
# 除算
POP
PUSH 1
SUB
# ( ... ( A B ... C ) N
DUP
PUSH 3
PUSH 1
ROLL
PUSH 1
ADD
PUSH 1
ROLL
DUP
PUSH 2
SUB
PUSH 2
PUSH 1
ROLL
# 除算は引数1個の時と>=2個の時で処理内容が違う
DUP
PUSH 3
SUB
JEZ DIV1
JMP DIVLOOP

LABEL DIV1
# ( ... ( ) A m 1
POP
POP
PUSH 1
PUSH 2
PUSH 1
ROLL
DIV
PUSH 1
# CANCELENDでPOPするためのダミーの数字
JMP CANCELEND

LABEL DIVLOOP
# ( ... ( ) A B .. C m N
PUSH 2
PUSH 1
ROLL
DUP
PUSH 1
SUB
JEZ DIVCOMPRESS
PUSH 2
PUSH 1
ROLL
PUSH 3
PUSH 1
ROLL
DUP
PUSH 4
PUSH 1
ROLL
PUSH 2
ADD
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C A B ..  m-1 N
JMP DIVLOOP

LABEL DIVCOMPRESS
POP
PUSH 1
SUB
PUSH 2
PUSH 1
ROLL
# ( ... ( ) C .. B N-1 A
LABEL DIVCOMPRESSLOOP
PUSH 2
PUSH 1
ROLL
DUP
PUSH 2
SUB
JEZ CANCELEND
PUSH 1
SUB
PUSH 3
PUSH 1
ROLL
PUSH 2
PUSH 1
ROLL
DIV
JMP DIVCOMPRESSLOOP
JMP BEGIN

LABEL CANCELEND
# ( ... ( ) SUM 0
POP
PUSH 3
PUSH 1
ROLL
POP
POP
PUSH 2
PUSH 1
ROLL
PUSH 1
ADD
JMP BEGIN
